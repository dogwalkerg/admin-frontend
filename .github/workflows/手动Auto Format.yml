name: æ‰‹åŠ¨Auto Format

on:
  pull_request_target:
    types: [opened, synchronize]
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      pull_request_number:
        description: 'PR ç¼–å·ï¼ˆå¯é€‰ï¼Œç”¨äºåœ¨ç°æœ‰ PR ä¸Šè¿è¡Œï¼‰'
        required: false
        type: string

jobs:
  auto-fix:
    if: github.actor != 'weblate'
    runs-on: ubuntu-latest
    steps:
      - name: è·å– PR ä¿¡æ¯ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        id: get_pr_info
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if ('${{ github.event.inputs.pull_request_number }}') {
              try {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: '${{ github.event.inputs.pull_request_number }}'
                });
                return {
                  head_ref: pr.data.head.ref,
                  head_repo: pr.data.head.repo.full_name
                };
              } catch (error) {
                console.log('æœªæ‰¾åˆ° PRï¼Œå°†åœ¨å½“å‰åˆ†æ”¯è¿è¡Œ');
                return { head_ref: null, head_repo: null };
              }
            }
            return { head_ref: null, head_repo: null };

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # æ ¹æ®è§¦å‘ç±»å‹é€‰æ‹©ä¸åŒçš„ ref
          ref: ${{ github.event_name == 'workflow_dispatch' && (steps.get_pr_info.outputs.head_ref || github.ref) || github.head_ref }}
          repository: ${{ github.event_name == 'workflow_dispatch' && (steps.get_pr_info.outputs.head_repo || github.repository) || github.event.pull_request.head.repo.full_name }}

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "latest"

      - name: Install dependencies
        run: bun install

      - name: Run formatter
        run: bun run format

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-fix formatting issues"
          commit_options: "--no-verify"
          file_pattern: ":(exclude).github/workflows/*"  # æ’é™¤å·¥ä½œæµæ–‡ä»¶é¿å…æƒé™é—®é¢˜

      - name: Add PR comment (PR è§¦å‘æ—¶)
        if: github.event_name == 'pull_request_target' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¨ ä»£ç æ ¼å¼é—®é¢˜å·²è‡ªåŠ¨ä¿®å¤ã€‚è¯·æ£€æŸ¥å˜æ›´å†…å®¹ã€‚'
            });

      - name: è¾“å‡ºæ‰‹åŠ¨è§¦å‘ç»“æœ
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… å·²æˆåŠŸä¿®å¤ä»£ç æ ¼å¼é—®é¢˜å¹¶æäº¤"
          else
            echo "â„¹ï¸ ä»£ç æ ¼å¼è‰¯å¥½ï¼Œæ— éœ€ä¿®å¤"
          fi
